<!DOCTYPE html>
<html>
<head>
  <title>Gmail Inbox Listener</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Para móvil -->
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #log { background: #222; color: #eee; padding: 1em; height: 200px; overflow-y: auto; font-size: 1em; }
    table { width: 100%; border-collapse: collapse; font-size: 1em; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    button { padding: 10px; font-size: 1em; margin: 10px 0; width: 100%; }
  </style>
</head>
<body>
  <h1>Correos Recibidos</h1>
  <table id="emails">
    <thead>
      <tr>
        <th>De</th>
        <th>Asunto</th>
        <th>Fecha</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button id="authorize_button">Conectar con Gmail</button>
  <button id="signout_button" style="display:none;">Desconectar</button>
  <h2>Flujo y errores</h2>
  <pre id="log"></pre>
  <!-- Scripts Google -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    const CLIENT_ID = '673848947640-mt8unrh2sbdcncee7nt2rsa7of2ul9e7.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyCMN2M55nYeAm2E-Qw4dOGByef4yOKN8t4';
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"];
    const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    function log(msg) {
      const logEl = document.getElementById('log');
      logEl.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function gapiLoaded() {
      log('Google API JS cargada.');
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      log('Inicializando GAPI Client...');
      try {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: DISCOVERY_DOCS,
        });
        gapiInited = true;
        log('GAPI Client inicializado.');
        enableAuthorize();
      } catch (error) {
        log('Error al inicializar GAPI Client: ' + JSON.stringify(error));
      }
    }

    function gisLoaded() {
      log('Google Identity Services cargada.');
      try {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: (response) => {
            if (response.error) {
              log('Error en autenticación: ' + JSON.stringify(response));
              return;
            }
            log('Usuario autenticado. Token obtenido.');
            listMessages();
          },
        });
        gisInited = true;
        log('GIS Client inicializado.');
        enableAuthorize();
      } catch (error) {
        log('Error al inicializar GIS Client: ' + JSON.stringify(error));
      }
    }

    function enableAuthorize() {
      if (gapiInited && gisInited) {
        document.getElementById('authorize_button').disabled = false;
        log('Botón "Conectar con Gmail" habilitado.');
      }
    }

    document.getElementById('authorize_button').onclick = () => {
      log('Solicitando token...');
      try {
        tokenClient.requestAccessToken();
      } catch (error) {
        log('Error al solicitar token: ' + JSON.stringify(error));
      }
    };

    document.getElementById('signout_button').onclick = () => {
      log('Desconectando usuario...');
      try {
        const token = gapi.client.getToken();
        if (token) {
          google.accounts.oauth2.revoke(token.access_token, () => {
            document.getElementById('signout_button').style.display = 'none';
            document.getElementById('authorize_button').style.display = '';
            log('Usuario desconectado.');
            document.querySelector('#emails tbody').innerHTML = '';
          });
        }
      } catch (error) {
        log('Error al desconectar: ' + JSON.stringify(error));
      }
    };

    async function listMessages() {
      log('Consultando correos...');
      try {
        const res = await gapi.client.gmail.users.messages.list({
          userId: 'me',
          maxResults: 10,
          labelIds: ['INBOX']
        });
        const messages = res.result.messages;
        const tbody = document.querySelector('#emails tbody');
        tbody.innerHTML = '';
        if (!messages || messages.length === 0) {
          log('No hay correos en la bandeja de entrada.');
          tbody.innerHTML = '<tr><td colspan="3">No hay correos en la bandeja de entrada.</td></tr>';
          return;
        }
        log(`Se encontraron ${messages.length} correos.`);
        for (const message of messages) {
          try {
            const msg = await gapi.client.gmail.users.messages.get({
              userId: 'me',
              id: message.id,
              format: 'metadata',
              metadataHeaders: ['From', 'Subject', 'Date']
            });
            let headers = msg.result.payload.headers;
            let from = headers.find(h => h.name === 'From')?.value || '';
            let subject = headers.find(h => h.name === 'Subject')?.value || '';
            let date = headers.find(h => h.name === 'Date')?.value || '';
            let row = `<tr><td>${from}</td><td>${subject}</td><td>${date}</td></tr>`;
            tbody.innerHTML += row;
            log(`Correo: ${subject} (${from})`);
          } catch (error) {
            log('Error al obtener correo: ' + JSON.stringify(error));
          }
        }
        document.getElementById('signout_button').style.display = '';
        document.getElementById('authorize_button').style.display = 'none';
      } catch (error) {
        log('Error al consultar correos: ' + JSON.stringify(error));
      }
    }

    // Inicialización segura para móvil
    document.getElementById('authorize_button').disabled = true;
    window.onload = function() {
      log('La página cargó correctamente.');
    }
    // Scripts Google: usa onload para asegurar inicialización
    window.gapiLoaded = gapiLoaded;
    window.gisLoaded = gisLoaded;
  </script>
  <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
  <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
</body>
</html>