<script src="https://apis.google.com/js/api.js"></script>
<script>
  const CLIENT_ID = '673848947640-mt8unrh2sbdcncee7nt2rsa7of2ul9e7.apps.googleusercontent.com';
  const API_KEY = 'AIzaSyCMN2M55nYeAm2E-Qw4dOGByef4yOKN8t4';

  const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"];
  const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';

  function handleClientLoad() {
    gapi.load('client:auth2', initClient);
  }

  function initClient() {
    gapi.client.init({
      apiKey: API_KEY,
      clientId: CLIENT_ID,
      discoveryDocs: DISCOVERY_DOCS,
      scope: SCOPES
    }).then(function () {
      gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
      updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
      document.getElementById('authorize_button').onclick = handleAuthClick;
      document.getElementById('signout_button').onclick = handleSignoutClick;
    });
  }

  function updateSigninStatus(isSignedIn) {
    if (isSignedIn) {
      listMessages();
    }
  }

  function handleAuthClick(event) {
    gapi.auth2.getAuthInstance().signIn();
  }

  function handleSignoutClick(event) {
    gapi.auth2.getAuthInstance().signOut();
    document.querySelector('#emails tbody').innerHTML = '';
  }

  function listMessages() {
    gapi.client.gmail.users.messages.list({
      'userId': 'me',
      'maxResults': 10
    }).then(function(response) {
      const messages = response.result.messages;
      const tbody = document.querySelector('#emails tbody');
      tbody.innerHTML = '';
      if (!messages) return;
      messages.forEach(function(message) {
        gapi.client.gmail.users.messages.get({
          'userId': 'me',
          'id': message.id
        }).then(function(msg) {
          let headers = msg.result.payload.headers;
          let from = headers.find(h => h.name === 'From')?.value || '';
          let subject = headers.find(h => h.name === 'Subject')?.value || '';
          let date = headers.find(h => h.name === 'Date')?.value || '';
          let row = `<tr><td>${from}</td><td>${subject}</td><td>${date}</td></tr>`;
          tbody.innerHTML += row;
        });
      });
    });
  }

  // Llama a la función al cargar la página
  window.onload = handleClientLoad;
</script>
<button id="authorize_button">Conectar con Gmail</button>
<button id="signout_button">Desconectar</button>